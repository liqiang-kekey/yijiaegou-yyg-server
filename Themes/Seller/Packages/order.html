<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <?php $shoname_name = D('Home/Front')->get_config_by_name('shoname'); ?>
    <title><?php echo $shoname; ?></title>
    <link rel="shortcut icon" href="" />

    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">

    <link rel="stylesheet" href="/layuiadmin/style/admin.css" media="all">

    <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
    <!--[if lt IE 9]>
    <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
    <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link href="./resource/css/bootstrap.min.css?v=201903260001" rel="stylesheet">
    <link href="./resource/css/common.css?v=201903260001" rel="stylesheet">
    <script type="text/javascript">
        window.sysinfo = {
        <?php if (!empty($_W['uniacid']) ){ ?>'uniacid': '{$_W['uniacid']}',<?php } ?>

        <?php if( !empty($_W['acid'])  ){ ?>'acid': '{$_W['acid']}',<?php } ?>

        <?php if (!empty($_W['openid']) ) { ?>'openid': '{$_W['openid']}',<?php } ?>

        <?php if( !empty($_W['uid']) ) {  ?>'uid': '{$_W['uid']}',<?php } ?>

        'isfounder': <?php if (!empty($_W['isfounder']) ) { ?>1<?php  }else{  ?>0<?php } ?>,

        'siteroot': '{$_W['siteroot']}',
            'siteurl': '{$_W['siteurl']}',
            'attachurl': '{$_W['attachurl']}',
            'attachurl_local': '{$_W['attachurl_local']}',
            'attachurl_remote': '{$_W['attachurl_remote']}',
            'module' : {'url' : '<?php if( defined('MODULE_URL') ) { ?>{MODULE_URL}<?php } ?>', 'name' : '<?php if (defined('IN_MODULE') ) { ?>{IN_MODULE}<?php } ?>'},
        'cookie' : {'pre': ''},
        'account' : {:json_encode($_W['account'])},
        };
    </script>

    <script type="text/javascript" src="./resource/js/lib/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="./resource/js/lib/bootstrap.min.js"></script>
    <script type="text/javascript" src="./resource/js/app/util.js?v=201903260001"></script>
    <script type="text/javascript" src="./resource/js/app/common.min.js?v=201903260001"></script>
    <script type="text/javascript" src="./resource/js/require.js?v=201903260001"></script>

    <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
    <link href="/static/css/snailfish.css" rel="stylesheet">
    <style>
        tbody tr td{
            position: relative;
        }
        tbody tr  .icow-weibiaoti--{
            visibility: hidden;
            display: inline-block;
            color: #fff;
            height:18px;
            width:18px;
            background: #e0e0e0;
            text-align: center;
            line-height: 18px;
            vertical-align: middle;
        }
        tbody tr:hover .icow-weibiaoti--{
            visibility: visible;
        }
        tbody tr  .icow-weibiaoti--.hidden{
            visibility: hidden !important;
        }
        .full .icow-weibiaoti--{
            margin-left:10px;
        }
        .full>span{
            display: -webkit-box;
            display: -webkit-flex;
            display: -ms-flexbox;
            display: flex;
            vertical-align: middle;
            align-items: center;
        }
        tbody tr .label{
            margin: 5px 0;
        }
        .goods_attribute a{
            cursor: pointer;
        }
        .newgoodsflag{
            width: 22px;height: 16px;
            background-color: #ff0000;
            color: #fff;
            text-align: center;
            position: absolute;
            bottom: 70px;
            left: 57px;
            font-size: 12px;
        }
        .a{cursor: pointer;}
        .daterangepicker select.ampmselect, .daterangepicker select.hourselect, .daterangepicker select.minuteselect{
            width:auto!important;
        }
        .we7-modal-dialog .modal-footer, .modal-dialog .modal-footer{padding:0px;}
        .modal-footer{padding:0px;}
    </style>
</head>
<body layadmin-themealias="default">

<table id="demo" lay-filter="test"></table>


<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-header layui-elem-quote">当前位置：<span class="line-text">卡券订单列表</span></div>

        <div class="layui-tab layui-tab-brief" >
            <ul class="layui-tab-title">

                <li  <?php if(empty($type) || $type=='all'){ ?>class="layui-this"<?php } ?>><a href="{:U('coin/order')}">全部订单（{$all_count}）</a></li>
            </ul>
        </div>

        <div class="layui-card-body" style="padding:15px;">
            <form action="" id="searchform" method="get" class="form-horizontal form-search layui-form" role="form">
                <input type="hidden" name="c" value="packages" />
                <input type="hidden" name="a" value="order" />
                <input type="hidden" name="type" value="{$type}" />

                <input type="hidden" name="sortfield" id="sortfield" value="{$sortfield}" />
                <input type="hidden" name="sortby" id="sortby" value="{$sortby}" />
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <div class="layui-input-inline" >
                            <input type="text" class="layui-input"  name="keyword" value="{$keyword}" placeholder="输入套餐商品名称"/>

                        </div>
                        <div class="layui-input-inline" style="width:280px;">
                            {:tpl_form_field_daterange('time', array('starttime'=>date('Y-m-d H:i', $starttime),'endtime'=>date('Y-m-d H:i', $endtime)),true);}
                        </div>
                        <div class="layui-input-inline" style="width:170px;">
                            <select name='searchfield' lay-ignore class='layui-input layui-unselect'   style="width:170px;padding:0 5px;"  >
                                <option value=''>请选择查询条件</option>
                                <option value='order_no' <?php if( $searchfield=='order_no'){ ?>selected<?php } ?>>订单号</option>
                                <option value='mobile' <?php if( $searchfield=='mobile'){ ?>selected<?php } ?>>联系电话</option>
                                <option value='name' <?php if( $searchfield=='name'){ ?>selected<?php } ?>>会员昵称</option>
                                <option value='member_id' <?php if( $searchfield=='member_id'){ ?>selected<?php } ?>>会员ID</option>
                                <option value='total_money' <?php if( $searchfield=='total_money'){ ?>selected<?php } ?>>价格</option>
                            </select>
                        </div>

                        <div class="layui-input-inline">
                            <button class="layui-btn layui-btn-sm" type="submit"> 搜索</button>
                            <button type="submit" name="export" data-export="1" value="1" class="layui-btn layui-btn-sm">导出</button>

                        </div>
                    </div>
                </div>
            </form>
            <form action="" class="layui-form" lay-filter="example" method="post" >

                <div class="row">
                    <div class="col-md-12">

                        <div class="page-table-header">

                            <!--<span class="pull-right">-->
                            <!--<a href="{:U('coin/addgoods', array('ok' =>1))}" class="layui-btn layui-btn-sm"><i class="fa fa-plus"></i> 添加商品</a>-->
                            <!--<button type="button" class="layui-btn layui-btn-sm exceledit" style="display:none;">excel导入编辑</button>-->
                            <!--</span>-->

                        </div>
                        <table class="table table-responsive" lay-even lay-skin="line" lay-size="lg">

                            <thead>
                            <tr>
                                <th style="width:25px;">
                                    <input type='checkbox' name="checkall" lay-skin="primary" lay-filter="checkboxall"  />
                                </th>
                                <th style="width:80px;text-align:center;">ID</th>
                                <th  style="width:120px;" >头像</th>
                                <th  style="width:120px;" >昵称</th>
                                <th style="width:230px;">订单号</th>
                                <th style="width:120px;">套餐名称</th>
                                <th  style="width:120px;" >下单时间</th>
                                <th  style="width:80px;" >下单人姓名</th>
                                <th  style="width:120px;" >下单人手机号</th>
                                <th  style="width:60px;" >推荐人</th>
                                <th  style="width:80px;" >支付金额</th>
                                <th  style="width:80px;" >状态</th>
                                <th style="width:120px;text-align:center;">操作</th>
                            </tr>
                            </thead>
                            <tbody>

                            <?php foreach($list as $item){  ?>
                            <tr>
                                <td>
                                    <input type='checkbox' name="item_checkbox" class="checkone" lay-skin="primary" value="{$item['id']}"/>
                                </td>
                                <td style="text-align:center;">
                                    {$item['id']}
                                </td>
                                <td >
                                    <img width="50" src="{:tomedia($item['avatar'])}" alt="" />
                                </td>
                                <td >
                                    {$item['username']}
                                </td>
                                <td  >
                                    <span class="text-danger">{$item['order_no']}</span>
                                </td>
                                <td  >
                                    <span class="text-danger">{$item['goods_name']}</span>
                                </td>
                                <td  >
                                    <span class="text-danger">{:date('Y-m-d H:i:s',$item['create_time'])}</span>
                                </td>
                                <td  >
                                    <span class="text-danger">{$item['name']}</span>
                                </td>
                                <td  >
                                    <span class="text-danger">{$item['mobile']}</span>
                                </td>
                                <td  >
                                    <span class="text-danger">
                                    	<?php if( $item['agent_id'] > 0 ){ ?>
                                    		{$item['agent_id']}
                                    	<?php } ?>
                                    </span>
                                </td>                                
                                <td  >
                                    <span class="text-danger">{$item['pay_money']}</span>
                                </td>
                                <td>
                                    <?php if( $item['status']==1 ){ ?>
                                    &nbsp;<span class="label label-success">已支付</span>
                                    <?php }else if($item['status']==0){ ?>
                                    &nbsp;<span class="label label-danger">未支付</span>
                                    <?php }else if($item['status']==2){ ?>
                                    &nbsp;<span class="label label-default">退款中</span>
                                    <?php }else if($item['status']==3){ ?>
                                    &nbsp;<span class="label label-success">退款完成</span>
                                    <?php } ?>
                                </td>
                              <td  style="overflow:visible;text-align: center;">
                                  <div class="btn-group">
                                    <?php if($item['status']==2){ ?>
                                    <a  class='layui-btn layui-btn-xs deldom' href="javascript:;" data-href="{:U('packages/refound',array('id' =>$item['id']))}" data-confirm='确认要同意退款吗?'>
                                        确认退款
                                    </a>
                                    <?php } ?>
                                      <a class="layui-btn layui-btn-xs" href="{:U('coin/order',array('package_id' => $item['id'], 'ok' => 1));}" title="">
                                        <span data-toggle="tooltip" data-placement="top" title="" data-original-title="卡券订单">
                                            卡券订单
                                        </span>
                                      </a>
                                  </div>
                                </td>

                                <!--<td  style="overflow:visible;position:relative">-->
                                <!--<a  class='layui-btn layui-btn-xs' href="{:U('coin/edit', array('id' => $item['id'],'ok'=>1,'page'=>$page))}"  >-->
                                <!--<i class="layui-icon layui-icon-edit"></i>编辑-->
                                <!--</a>-->
                                <!--<?php if($type!='recycle'){ ?>-->
                                <!--<a  class='layui-btn layui-btn-xs deldom' href="javascript:;" data-href="{:U('coin/delete',array('id' => $item['id']))}" data-confirm='确认要删除吗?'>-->
                                <!--<i class="layui-icon">&#xe640;</i>删除-->
                                <!--</a>-->
                                <!--<?php } ?>-->
                                </td>
                            </tr>
                            <?php } ?>
                            </tbody>
                            <tfoot>
                            <tr>

                                <td colspan="6" style="text-align: right">
                                    {$pager}
                                </td>
                            </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>








<div id="excel_goods_edit" style="display:none;">
    <form action="{:U('goods/excel_goodslist_edit')}" method="post"  enctype="multipart/form-data" >
        <div class="layui-card">
            <div class="layui-card-body">
                <div class="modal-body" >
                    <div class="layui-form-item">
                        <label class="layui-form-label">excel文件</label>
                        <div class="layui-input-block">
                            <input type="file" name="excel">
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </form>
</div>







<script src="/layuiadmin/layui/layui.js"></script>

<script>
    layui.config({
        base: '/layuiadmin/' //静态资源所在路径
    }).extend({
        index: 'lib/index' //主入口模块
    }).use('index');
</script>

<script>
    //由于模块都一次性加载，因此不用执行 layui.use() 来加载对应模块，直接使用即可：
    var layer = layui.layer;
    var $;

    layui.use(['jquery', 'layer','form'], function(){
        $ = layui.$;
        var form = layui.form;
        $('.btn_export').click(function(){
            //
            $('#export').val(1);
            var form_data = $('.form-search').serialize();



            var a = form_data.replace('c=order&a=index','');
            var s = a.replace('c=communityhead&a=distributionorder','');

            s = s.replace('c=distribution&a=distributionorder','');


            $.post("{:U('packages/export_form', array('sec' => 1) )}", s, function(shtml){
                layer.open({
                    type: 1,
                    area: '930px',
                    content: shtml //注意，如果str是object，那么需要字符拼接。
                });
            });
            return false;

        })
        $('.exceledit').click(function(){
            //页面层
            layer.open({
                type: 1,
                title:'excel导入编辑商品',
                area: ['520px', '240px'], //宽高
                content: $('#excel_goods_edit'),
                btn:['提交','取消'],
                btn1:function(){
                    $('#excel_goods_edit').find('form').submit();
                }
            });
        })

        $('.deldom').click(function(){
            var s_url = $(this).attr('data-href');
            layer.confirm($(this).attr('data-confirm'), function(index){
                $.ajax({
                    url:s_url,
                    type:'post',
                    dataType:'json',
                    success:function(info){

                        if(info.status == 0)
                        {
                            layer.msg(info.result.message,{icon: 1,time: 2000});
                        }else if(info.status == 1){
                            var go_url = location.href;
                            if( info.result.hasOwnProperty("url") )
                            {
                                go_url = info.result.url;
                            }

                            layer.msg('操作成功',{time: 1000,
                                end:function(){
                                    location.href = info.result.url;
                                }
                            });
                        }
                    }
                })
            });
        })

        $('.btn-operation').click(function(){
            var ids_arr = [];
            var obj = $(this);
            var s_toggle = $(this).attr('data-toggle');
            var s_url = $(this).attr('data-href');


            $("input[name=item_checkbox]").each(function() {

                if( $(this).prop('checked') )
                {
                    ids_arr.push( $(this).val() );
                }
            })
            if(ids_arr.length < 1)
            {
                layer.msg('请选择要操作的内容');
                return false;
            }else{
                var can_sub = true;
                if( s_toggle == 'batch-remove' )
                {
                    can_sub = false;

                    layer.confirm($(obj).attr('data-confirm'), function(index){
                        $.ajax({
                            url:s_url,
                            type:'post',
                            dataType:'json',
                            data:{ids:ids_arr},
                            success:function(info){

                                if(info.status == 0)
                                {
                                    layer.msg(info.result.message,{time: 1000,
                                        end:function(){
                                            location.href = info.result.url;
                                        }
                                    });

                                }else if(info.status == 1){
                                    var go_url = location.href;
                                    if( info.result.hasOwnProperty("url") )
                                    {
                                        go_url = info.result.url;
                                    }

                                    layer.msg('操作成功',{time: 1000,
                                        end:function(){
                                            location.href = info.result.url;
                                        }
                                    });
                                }
                            }
                        })
                    });
                }else{
                    $.ajax({
                        url:s_url,
                        type:'post',
                        dataType:'json',
                        data:{ids:ids_arr},
                        success:function(info){

                            if(info.status == 0)
                            {
                                layer.msg(info.result.message,{time: 1000,
                                    end:function(){
                                        location.href = info.result.url;
                                    }
                                });
                            }else if(info.status == 1){
                                var go_url = location.href;
                                if( info.result.hasOwnProperty("url") )
                                {
                                    go_url = info.result.url;
                                }

                                layer.msg('操作成功',{time: 1000,
                                    end:function(){
                                        location.href = info.result.url;
                                    }
                                });

                            }
                        }
                    })
                }
            }
        })



        form.on('switch(cmwsitch)', function(data){

            var s_url = $(this).attr('data-href')

            var is_take_fullreduction = 1;
            if(data.elem.checked)
            {
                is_take_fullreduction = 1;
            }else{
                is_take_fullreduction = 0;
            }

            $.ajax({
                url:s_url,
                type:'post',
                dataType:'json',
                data:{value:is_take_fullreduction},
                success:function(info){

                    if(info.status == 0)
                    {
                        layer.msg(info.result.message,{icon: 1,time: 2000});
                    }else if(info.status == 1){
                        var go_url = location.href;
                        if( info.result.hasOwnProperty("url") )
                        {
                            go_url = info.result.url;
                        }

                        layer.msg('操作成功',{time: 1000,
                            end:function(){
                                location.href = info.result.url;
                            }
                        });
                    }
                }
            })
        });

        form.on('switch(groundingsitch)', function(data){

            var s_url = $(this).attr('data-href')

            var grounding = 1;
            if(data.elem.checked)
            {
                grounding = 1;
            }else{
                grounding = 0;
            }

            $.ajax({
                url:s_url,
                type:'post',
                dataType:'json',
                data:{value:grounding},
                success:function(info){

                    if(info.status == 0)
                    {
                        layer.msg(info.result.message,{icon: 1,time: 2000});
                    }else if(info.status == 1){
                        var go_url = location.href;
                        if( info.result.hasOwnProperty("url") )
                        {
                            go_url = info.result.url;
                        }

                        layer.msg('操作成功',{time: 1000,
                            end:function(){
                                location.href = info.result.url;
                            }
                        });
                    }
                }
            })
        });




        form.on('switch(unengroundingsitch)', function(data){

            var s_url = $(this).attr('data-href')

            var grounding = 1;
            if(data.elem.checked)
            {
                grounding = 5;
            }

            $.ajax({
                url:s_url,
                type:'post',
                dataType:'json',
                data:{value:grounding},
                success:function(info){

                    if(info.status == 0)
                    {
                        layer.msg(info.result.message,{icon: 1,time: 2000});
                    }else if(info.status == 1){
                        var go_url = location.href;
                        if( info.result.hasOwnProperty("url") )
                        {
                            go_url = info.result.url;
                        }

                        layer.msg('操作成功',{time: 1000,
                            end:function(){
                                location.href = info.result.url;
                            }
                        });
                    }
                }
            })
        });

        form.on('switch(engroundingsitch)', function(data){

            var s_url = $(this).attr('data-href')

            var grounding = 1;
            if(data.elem.checked)
            {
                grounding = 1;
            }else{
                grounding = 5;
            }

            $.ajax({
                url:s_url,
                type:'post',
                dataType:'json',
                data:{value:grounding},
                success:function(info){

                    if(info.status == 0)
                    {
                        layer.msg(info.result.message,{icon: 1,time: 2000});
                    }else if(info.status == 1){
                        var go_url = location.href;
                        if( info.result.hasOwnProperty("url") )
                        {
                            go_url = info.result.url;
                        }

                        layer.msg('操作成功',{time: 1000,
                            end:function(){
                                location.href = info.result.url;
                            }
                        });
                    }
                }
            })
        });


        form.on('switch(undowngroundingsitch)', function(data){

            var s_url = $(this).attr('data-href')

            var grounding = 1;
            if(data.elem.checked)
            {
                grounding = 1;
            }else{
                grounding = 0;
            }

            $.ajax({
                url:s_url,
                type:'post',
                dataType:'json',
                data:{value:grounding},
                success:function(info){

                    if(info.status == 0)
                    {
                        layer.msg(info.result.message,{time: 1000,
                            end:function(){
                                location.href = info.result.url;
                            }
                        });

                    }else if(info.status == 1){
                        var go_url = location.href;
                        if( info.result.hasOwnProperty("url") )
                        {
                            go_url = info.result.url;
                        }

                        layer.msg('操作成功',{time: 1000,
                            end:function(){
                                location.href = info.result.url;
                            }
                        });
                    }
                }
            })
        });


        form.on('switch(is_index_showsitch)', function(data){

            var s_url = $(this).attr('data-href')

            var is_index_show = 1;
            if(data.elem.checked)
            {
                is_index_show = 1;
            }else{
                is_index_show = 0;
            }

            $.ajax({
                url:s_url,
                type:'post',
                dataType:'json',
                data:{value:is_index_show},
                success:function(info){

                    if(info.status == 0)
                    {
                        layer.msg(info.result.message,{time: 1000,
                            end:function(){
                                location.href = info.result.url;
                            }
                        });
                    }else if(info.status == 1){
                        var go_url = location.href;
                        if( info.result.hasOwnProperty("url") )
                        {
                            go_url = info.result.url;
                        }

                        layer.msg('操作成功',{time: 1000,
                            end:function(){
                                location.href = info.result.url;
                            }
                        });
                    }
                }
            })
        });



        form.on('switch(istop_showsitch)', function(data){

            var s_url = $(this).attr('data-href')

            var istop = 1;
            if(data.elem.checked)
            {
                istop = 1;
            }else{
                istop = 0;
            }

            $.ajax({
                url:s_url,
                type:'post',
                dataType:'json',
                data:{value:istop},
                success:function(info){

                    if(info.status == 0)
                    {
                        layer.msg(info.result.message,{time: 1000,
                            end:function(){
                                location.href = info.result.url;
                            }
                        });
                    }else if(info.status == 1){
                        var go_url = location.href;
                        if( info.result.hasOwnProperty("url") )
                        {
                            go_url = info.result.url;
                        }

                        layer.msg('操作成功',{time: 1000,
                            end:function(){
                                location.href = info.result.url;
                            }
                        });
                    }
                }
            })
        });

        form.on('switch(restwsitch)', function(data){

            var s_url = $(this).attr('data-href')

            var rest = 1;
            if(data.elem.checked)
            {
                rest = 1;
            }else{
                rest = 0;
            }

            $.ajax({
                url:s_url,
                type:'post',
                dataType:'json',
                data:{rest:rest},
                success:function(info){

                    if(info.status == 0)
                    {
                        layer.msg(info.result.message,{time: 1000,
                            end:function(){
                                location.href = info.result.url;
                            }
                        });
                    }else if(info.status == 1){
                        var go_url = location.href;
                        if( info.result.hasOwnProperty("url") )
                        {
                            go_url = info.result.url;
                        }

                        layer.msg('操作成功',{time: 1000,
                            end:function(){
                                location.href = info.result.url;
                            }
                        });
                    }
                }
            })
        });
        form.on('switch(enablewsitch)', function(data){

            var s_url = $(this).attr('data-href')

            var enable = 1;
            if(data.elem.checked)
            {
                enable = 1;
            }else{
                enable = 0;
            }

            $.ajax({
                url:s_url,
                type:'post',
                dataType:'json',
                data:{enable:enable},
                success:function(info){

                    if(info.status == 0)
                    {
                        layer.msg(info.result.message,{icon: 1,time: 2000});
                    }else if(info.status == 1){
                        var go_url = location.href;
                        if( info.result.hasOwnProperty("url") )
                        {
                            go_url = info.result.url;
                        }

                        layer.msg('操作成功',{time: 1000,
                            end:function(){
                                location.href = info.result.url;
                            }
                        });
                    }
                }
            })
        });

        form.on('switch(statewsitch)', function(data){

            var s_url = $(this).attr('data-href')

            var state = 1;
            if(data.elem.checked)
            {
                state = 1;
            }else{
                state = 0;
            }

            $.ajax({
                url:s_url,
                type:'post',
                dataType:'json',
                data:{state:state},
                success:function(info){

                    if(info.status == 0)
                    {
                        layer.msg(info.result.message,{icon: 1,time: 2000});
                    }else if(info.status == 1){
                        var go_url = location.href;
                        if( info.result.hasOwnProperty("url") )
                        {
                            go_url = info.result.url;
                        }

                        layer.msg('操作成功',{time: 1000,
                            end:function(){
                                location.href = info.result.url;
                            }
                        });
                    }
                }
            })
        });
        form.on('checkbox(checkboxall)', function(data){

            if(data.elem.checked)
            {
                $("input[name=item_checkbox]").each(function() {
                    $(this).prop("checked", true);
                });
                $("input[name=checkall]").each(function() {
                    $(this).prop("checked", true);
                });

            }else{
                $("input[name=item_checkbox]").each(function() {
                    $(this).prop("checked", false);
                });
                $("input[name=checkall]").each(function() {
                    $(this).prop("checked", false);
                });
            }

            form.render('checkbox');
        });

        //监听提交
        form.on('submit(formDemo)', function(data){

            $.ajax({
                url: data.form.action,
                type: data.form.method,
                data: data.field,
                dataType:'json',
                success: function (info) {

                    if(info.status == 0)
                    {
                        layer.msg(info.result.message,{icon: 1,time: 2000});
                    }else if(info.status == 1){
                        var go_url = location.href;
                        if( info.result.hasOwnProperty("url") )
                        {
                            go_url = info.result.url;
                        }

                        layer.msg('操作成功',{time: 1000,
                            end:function(){
                                location.href = info.result.url;
                            }
                        });
                    }
                }
            });

            return false;
        });
    })

</script>
<script type="text/javascript" src="/static/js/dist/area/cascade.js"></script>
<script>
    var heads_page = 1;

    $("body").delegate("#batchheads_page .pagination a","click",function(){
        heads_page = $(this).attr('page');
        search_heads_do();
    })
    function search_heads()
    {
        heads_page = 1;
        search_heads_do();
    }
    function search_heads_do()
    {
        var province_name = $('#sel-provance').val();
        var city_name = $('#sel-city').val();
        var area_name = $('#sel-area').val();
        var country_name = $('#sel-street').val();
        var keyword = $('#supply_id_input').val();

        $.post("{:U('communityhead/query_head')}",{page:heads_page,'province_name':province_name,'city_name': city_name,'area_name':area_name,'country_name':country_name,'keyword':keyword},
            function (ret) {
                if (ret.status == 1) {
                    $('#batchheads_content').html(ret.html);
                    $('#batchheads_page').html(ret.page_html);
                    return
                } else {
                    layer.msg('修改失败');
                }
            }, 'json');
    }
    //显示批量分类
    $('#batchcatesbut').click(function () {
        //  var index = layer.load(1);
        var index = layer.open({
            type: 1,
            area: '500px',
            title: '选取分类'
            ,content: $('#batchcates_html').html(),
            yes: function(index, layero){
                //do something
                layer.close(index); //如果设定了yes回调，需进行手工关闭
            }
        });
    })

    $('#batch_head_group').click(function () {
        //  var index = layer.load(1);
        var index = layer.open({
            type: 1,
            area: '500px',
            title: '选取团长分组'
            ,content: $('#batchcates_headgroup_html').html(),
            yes: function(index, layero){
                //do something
                layer.close(index); //如果设定了yes回调，需进行手工关闭
            }
        });
    })

    $('#batch_head_group2').click(function () {
        //  var index = layer.load(1);
        var index = layer.open({
            type: 1,
            area: '500px',
            title: '选取团长分组'
            ,content: $('#batchcates_headgroup_html').html(),
            yes: function(index, layero){
                //do something
                layer.close(index); //如果设定了yes回调，需进行手工关闭
            }
        });
    })


    $('.check_heads_all').click(function(){
        //head_id
        if($(this).is(':checked')){
            $('.head_id').prop('checked',true);
        }else{
            $('.head_id').prop('checked',false);
        }
    })
    $('#batch_head,#batch_head2').click(function(){

        cascdeInit("1","1","","","","");
        search_heads_do();


        var offs_lf = ( $(window).width() -720 )/2;
        var offs_ht = ( $(window).height() -690 )/2;


        $('#batchheads .modal-dialog').css('top',offs_ht+'px');
        $('#batchheads .modal-dialog').css('margin-top','0px');

        $('#batchheads .modal-dialog').css('left',offs_lf+'px');
        $('#batchheads .modal-dialog').css('margin-left','0px');

        $('#batchheads').show();
    })



    $('#batchcatesbut2').click(function () {
        var index = layer.open({
            type: 1,
            area: '500px',
            title: '选取分类'
            ,content: $('#batchcates_html').html(),
            yes: function(index, layero){
                //do something
                layer.close(index); //如果设定了yes回调，需进行手工关闭
            }
        });
    })

    //关闭批量分类
    $('.modal-header .close').click(function () {
        $('#batchcates').hide();
        $('#batchheads').hide();
        $('#batch_time').hide();
    })

    // 取消批量分类
    $('.modal-footer .btn.btn-default').click(function () {
        $('#batchcates').hide();
        $('#batchheads').hide();
        $('#batch_time').hide();
    })
    $('.model_heads').click(function(){
        var head_id_arr = [];
        $('.head_id').each(function(){
            if($(this).is(':checked')) {
                head_id_arr.push( $(this).val() )
            }
        })

        //modal-group-head
        var is_clear_old = 0;

        if( $('#is_cancle_old').is(':checked') )
        {
            is_clear_old = 1;
        }


        if(head_id_arr.length > 0)
        {
            var selected_checkboxs = $('.table-responsive tbody tr td:first-child [type="checkbox"]:checked');
            var goodsids = selected_checkboxs.map(function () {
                return $(this).val()
            }).get();

            $.post("{:U('goods/ajax_batchheads')}",{'goodsids':goodsids,'head_id_arr': head_id_arr,'is_clear_old':is_clear_old}, function (ret) {
                if (ret.status == 1) {
                    $('#batchheads').hide();
                    layer.msg('分配成功', {
                        time: 1000
                    }, function(){
                        window.location.reload();
                    });

                    return
                } else {
                    layer.msg('修改失败');
                }
            }, 'json');
        }else{
            layer.msg('请选择团长');
        }
    })
    //确认
    var cates2 = 0;
    $("body").delegate("#cates2","click",function(){

        cates2 =  $(this).val() ;
    })

    var group_heads2 = 'default';
    $("body").delegate("#group_heads","click",function(){
        group_heads2 =  $(this).val() ;
    })


    $("body").delegate(".cancle","click",function(){
        layer.closeAll();
    })



    $("body").delegate(".modal-group-head","click",function(){

        var group_heads=$('#group_heads').val();
        if(group_heads2 != 'default')
        {
            group_heads = group_heads2;
        }

        var selected_checkboxs = $('.table-responsive tbody tr td:first-child [type="checkbox"]:checked');
        var goodsids = selected_checkboxs.map(function () {
            return $(this).val()
        }).get();

        if(goodsids.length <=0 )
        {
            layer.msg('请先选择商品');
            return false;
        }


        var is_clear_old = 0;

        $('.is_cancle_old2').each(function(){
            if( $(this).is(':checked') )
            {
                is_clear_old = 1;
            }
        })

        console.log(is_clear_old);




        var iscover=$('input[name="iscover"]:checked').val();
        $.post("{:U('goods/ajax_batchcates_headgroup')}",{'goodsids':goodsids,'groupid': group_heads,'is_clear_old' : is_clear_old }, function (ret) {
            if (ret.status == 1) {

                layer.msg('分配成功', {
                    time: 1000
                }, function(){
                    window.location.reload();
                });

                return
            } else {
                layer.msg('分配失败');
            }
        }, 'json');
    })

    $('.layui-table-sort').click(function(){
        $(this).attr('lay-sort','asc');
    })

    $("body").delegate(".modal-fenlei","click",function(){

        var cates=$('#cates2').val();
        if(cates2 != 0)
        {
            cates = cates2;
        }


        var selected_checkboxs = $('.table-responsive tbody tr td:first-child [type="checkbox"]:checked');
        var goodsids = selected_checkboxs.map(function () {
            return $(this).val()
        }).get();
        //id="cates"
        var iscover=$('input[name="iscover"]:checked').val();
        $.post("{:U('goods/ajax_batchcates')}",{'goodsids':goodsids,'cates': cates,'iscover':iscover}, function (ret) {
            if (ret.status == 1) {
                $('#batchcates').hide();

                layer.msg('修改成功', {
                    time: 1000
                }, function(){
                    window.location.reload();
                });

                return
            } else {
                layer.msg('修改失败');
            }
        }, 'json');
    })
    //----

    //显示时间设置
    $('#batchtime,#batchtime2').click(function () {

        var offs_lf = ( $(window).width() -720 )/2;
        var offs_ht = ( $(window).height() -290 )/2;

        $('#batch_time .modal-dialog').css('top',offs_ht+'px');
        $('#batch_time .modal-dialog').css('margin-top','0px');

        $('#batch_time .modal-dialog').css('left',offs_lf+'px');
        $('#batch_time .modal-dialog').css('margin-left','0px');

        $('#batch_time').show();
    })

    $('.modal-time').click(function () {
        var selected_checkboxs = $('.table-responsive tbody tr td:first-child [type="checkbox"]:checked');
        var goodsids = selected_checkboxs.map(function () {
            return $(this).val()
        }).get();

        var begin_time=$('#batch_time input[name="setsametime[start]"]').val();
        var end_time=$('#batch_time input[name="setsametime[end]"]').val();
        $.post("{:U('goods/ajax_batchtime')}",{'goodsids':goodsids,'begin_time': begin_time,'end_time':end_time}, function (ret) {
            if (ret.status == 1) {
                $('#batch_time').hide();
                layer.msg('设置成功');
                window.location.reload();
                return
            } else {
                layer.msg('设置失败');
            }
        }, 'json');
    })

    $(document).on("click", '[data-toggle="ajaxEdit"]', function(e) {
        var obj = $(this),
            url = obj.data('href') || obj.attr('href'),
            data = obj.data('set') || {},
            html = $.trim(obj.text()),
            required = obj.data('required') || true,
            edit = obj.data('edit') || 'input';
        var oldval = $.trim($(this).text());
        e.preventDefault();
        submit = function() {
            e.preventDefault();
            var val = $.trim(input.val());
            if (required) {
                if (val == '') {
                    layer.msg(tip.lang.empty);
                    return
                }
            }
            if (val == html) {
                input.remove(), obj.html(val).show();
                return
            }
            if (url) {
                $.post(url, {
                    value: val
                }, function(ret) {
                    ret = eval("(" + ret + ")");
                    if (ret.status == 1) {
                        obj.html(val).show()
                    } else {
                        layer.msg(ret.result.message, ret.result.url)
                    }
                    input.remove()
                }).fail(function() {
                    input.remove(),  layer.msg(tip.lang.exception)
                })
            } else {
                input.remove();
                obj.html(val).show()
            }
            obj.trigger('valueChange', [val, oldval])
        }, obj.hide().html('<i class="fa fa-spinner fa-spin"></i>');
        var input = $('<input type="text" class="form-control input-sm" style="width: 80%;display: inline;" />');
        if (edit == 'textarea') {
            input = $('<textarea type="text" class="form-control" style="resize:none" rows=3 ></textarea>')
        }
        obj.after(input);
        input.val(html).select().blur(function() {
            submit(input)
        }).keypress(function(e) {
            if (e.which == 13) {
                submit(input)
            }
        })
    })
</script>
</body>